<div class="mb-5" id="personal-area">
  <h2 class="mb-1">{{ 'IXIPC-hi'|l10n(lang) }}, {{ g.IXIPC_user.name }}!</h2>
  <p class="lead mb-5">{{ 'IXIPC-register-to-submit-logged-in'|l10n(lang) }}</p>

  <!-- Personal data form -->
  <div class="container mb-5">
    <form id="personal-data" action="">
      {{ registration_form.csrf_token }}
      <div class="rounded-4 card mb-3 abstract-new">
        <div class="card-body">
          <h5 class="card-title mb-0">
            {{ 'IXIPC-personal-data'|l10n(lang) }}
          </h5>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="email" class="form-label">Email</label>
          <input class="form-control" name="email" id="email" type="text" value="{{g.IXIPC_user.email}}" disabled>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="first-name" class="form-label">{{ 'IXIPC-personal-data-first-name'|l10n(lang) }}</label>
          <input name="first-name" id="first-name" type="text" class="form-control" value="{{g.IXIPC_user.first_name if g.IXIPC_user.first_name else ''}}">
        </div>
        <div class="col">
          <label for="last-name" class="form-label">{{ 'IXIPC-personal-data-last-name'|l10n(lang) }}</label>
          <input name="last-name" id="last-name" type="text" class="form-control" value="{{g.IXIPC_user.last_name if g.IXIPC_user.last_name else ''}}">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="institution" class="form-label">{{ 'IXIPC-personal-data-institution'|l10n(lang) }}</label>
          <input name="institution" id="institution" type="text" class="form-control" value="{{g.IXIPC_user.institution if g.IXIPC_user.institution else ''}}">
        </div>
      </div>
      <div class="row mb-0">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="student"{{' checked' if g.IXIPC_user.student}}>
            <label for="student" class="form-label">{{ 'IXIPC-personal-data-student'|l10n(lang) }}</label>
          </div>
        </div>
        <div class="col-auto" id="student-volunteer" hidden>
          <p class="m-0 p-0">{{ 'IXIPC-personal-data-volunteer'|l10n(lang) }}</p>
        </div>
      </div>
      <div class="row mb-0">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="member"{{' checked' if g.IXIPC_user.member}}>
            <label for="member" class="form-label">{{ 'IXIPC-personal-data-member'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      <div class="row mb-0" id="scholarship-selector" hidden>
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="scholarship"{{' checked' if g.IXIPC_user.scholarship}}>
            <label for="scholarship" class="form-label">{{ 'IXIPC-personal-data-scholarship'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      <div class="row mb-0" id="unemployed-selector">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="unemployed"{{' checked' if g.IXIPC_user.unemployed}}>
            <label for="unemployed" class="form-label">{{ 'IXIPC-payment-unemployed'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      <div class="row mb-0" id="competition-photography-selector">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="competition-photography"{{' checked' if g.IXIPC_user.competition_photography}}>
            <label for="competition-photography" class="form-label">{{ 'IXIPC-personal-data-competition-photography'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      <div class="row mb-0" id="competition-talk-selector" hidden>
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="competition-talk"{{' checked' if g.IXIPC_user.competition_talk}}>
            <label for="competition-talk" class="form-label">{{ 'IXIPC-personal-data-competition-talk'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      {# Uncomment to activate dinner options #}
      {# <div class="row mb-0" id="dinner-selector">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="dinner"{{' checked' if g.IXIPC_user.dinner}}>
            <label for="dinner" class="form-label">{{ 'IXIPC-personal-data-dinner'|l10n(lang) }}</label>
          </div>
        </div>
      </div>
      <div class="row mb-0 ms-1" id="dinner-type-selector" hidden>
        <div class="col">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="dinner-type" value="1" role="switch" id="dinner-type-no-restrictions"{{' checked' if g.IXIPC_user.dinner_type == 1}}>
            <label for="dinner-type-no-restrictions" class="form-check-label">{{ 'IXIPC-personal-data-dinner-no-restrictions'|l10n(lang) }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="dinner-type" value="2" role="switch" id="dinner-type-vegetarian"{{' checked' if g.IXIPC_user.dinner_type == 2}}>
            <label for="dinner-type-vegetarian" class="form-check-label">{{ 'IXIPC-personal-data-dinner-vegetarian'|l10n(lang) }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="dinner-type" value="3" role="switch" id="dinner-type-vegan"{{' checked' if g.IXIPC_user.dinner_type == 3}}>
            <label for="dinner-type-vegan" class="form-check-label">{{ 'IXIPC-personal-data-dinner-vegan'|l10n(lang) }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="dinner-type" value="4" role="switch" id="dinner-type-other-restrictions"{{' checked' if g.IXIPC_user.dinner_type == 4}}>
            <label for="dinner-type-other-restrictions" class="form-check-label">{{ 'IXIPC-personal-data-dinner-other-restrictions'|l10n(lang) }}</label>
          </div>
        </div>
      </div> #}
    </form>
  </div>

  <!-- Payment form -->
  <div class="container mb-5">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-registration'|l10n(lang) }}
        </h5>
      </div>
    </div>
    <div class="mt-3" id="payment">
      {# <h5>Preços</h5> #}

      <h5>{{ 'IXIPC-payment-available-after'|l10n(lang) }}</h5>

      {# {% if payment_status == 0 -%}
        <h5>{{ 'IXIPC-payment-methods-available'|l10n(lang) }}</h5>
      {% endif -%}
      <div id="payment-methods" class="mb-3">
        <div class="row">
          {% if payment_status == 0 -%}
            {% include 'partials/payment-methods.html' -%}
          {% elif payment_status == 1 -%}
            {% include 'partials/payment-success.html' -%}
          {% elif payment_status == 2 -%}
            {% include 'partials/payment-pending.html' -%}
          {% endif -%}
          <div class="col-2 ms-0 ps-0">
            <div class="card text-center w-100 h-100 rounded-start-0 price d-flex">
              <div class="flex-fill"></div>
              <h5 class="card-title mt-2 mb-1">Total</h5>
              <p class="card-text lead" id="final-price">100€</p>
              <div class="flex-fill"></div>
            </div>
          </div>
        </div>
      </div>
      {% if payment_status == 0 -%}
      <div class="row">
        <div class="col-auto">
          <button type="submit" class="btn btn-primary" id="button-payment">{{ 'IXIPC-payment-pay'|l10n(lang) }}</button>
        </div>
        <div class="col" id="payment-notification"></div>
      </div>
      {% endif -%} #}
    </div>
  </div>

  <!-- Abstracts -->
  <div class="container mb-5">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-abstract-body'|l10n(lang) }}s
        </h5>
      </div>
    </div>
    {% if lang == 'pt' -%}
    <div class="mb-3">
      <small>Apenas são aceites resumos em inglês</small>
    </div>
    {% endif -%}

    <div class="container mb-5">
      <div id="abstract-forms-container">
        {% for abstract in abstracts -%}
        <div id="abstract-{{ abstract.id }}">
          {% include "abstract-form-closed.html" -%}
        </div>
        {% endfor -%}
      </div>
      {% if submission_open -%}
        <form id="abstract-new" action="" class="mb-5">
          {{ registration_form.csrf_token }}
          <button type="button" class="btn btn-primary text-white" type="submit">
            <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
            <span class="text-white">{{ 'IXIPC-abstract-new-abstract'|l10n(lang) }}</span>
          </button>
        </form>
      {% else -%}
        <p>{{ 'IXIPC-abstract-submission-closed'|l10n(lang) }}</p>
      {% endif -%}
    </div>

    {# <div class="row">
      <div class="col-auto">
        <button type="button" class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#edit-authors-modal">
          Create/edit authors
        </button>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#edit-institutions-modal">
          Create/edit institutions
        </button>
      </div>
    </div> #}
  </div>

  <!-- Authors -->
  <div class="modal modal-lg fade" id="edit-authors-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editAuthorsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-black">
        <div class="modal-header border-0">
          <h1 class="modal-title mb-0" id="editAuthorsModal">{{ 'IXIPC-abstract-authors'|l10n(lang)|l10n(lang) }}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion mb-2" id="accordion-authors"></div>
        </div>
        <div class="modal-footer border-0 mt-0">
          <div class="container">
            <div class="d-flex flex-row mb-1">
              <div class="col justify-content-start">
                <h5 data-bs-toggle="modal" data-bs-target="#edit-institutions-modal"><span class="edit-button">< {{ 'IXIPC-abstract-institutions'|l10n(lang)|l10n(lang) }}</span></h5>
              </div>
              <div class="col d-flex justify-content-end">
                <button type="button" class="btn btn-primary text-white" type="submit" id="new-author-button">
                  <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
                  <span class="text-white">{{ 'IXIPC-abstract-new-author'|l10n(lang) }}</span>
                </button>
              </div>
            </div>  
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Institutions -->
  <div class="modal modal-lg fade" id="edit-institutions-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editInstitutionsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-black">
        <div class="modal-header border-0">
          <h1 class="modal-title mb-0" id="editInstitutionsModal">{{ 'IXIPC-abstract-institutions'|l10n(lang)|l10n(lang) }}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion mb-2" id="accordion-institutions"></div>
        </div>
        <div class="modal-footer border-0 mt-0">
          <div class="container">
            <div class="d-flex flex-row mb-1">
              <div class="col justify-content-start">
                <h5 data-bs-toggle="modal" data-bs-target="#edit-authors-modal"><span class="edit-button">< {{ 'IXIPC-abstract-authors'|l10n(lang)|l10n(lang) }}</span></h5>
              </div>
              <div class="col d-flex justify-content-end">
                <button type="button" class="btn btn-primary text-white" type="submit" id="new-institution-button">
                  <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
                  <span class="text-white">{{ 'IXIPC-abstract-new-institution'|l10n(lang) }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout -->
  <div class="mb-5">
    <form action="{{ url_for('IX_IPC.logout', language=lang) }}" method="post">
      {{ registration_form.csrf_token }}
      <input type="hidden" id="user_id" name="user_id" value="{{ g.user.id }}"> 
      <button type="submit" class="btn btn-primary">{{ 'IXIPC-logout'|l10n(lang) }}</button>
    </form>  
  </div>
</div>

{% include "scripts/utilities.html" -%}
{# {% include "scripts/upload-form.html" -%} #}
{% include "scripts/word-counter.html" -%}
{% include "scripts/open-abstract.html" -%}
<script src="{{ url_for('static', filename='js/Sortable.js') }}"></script>
{# {% include "scripts/authors-manager.html" -%} #}
{% include "scripts/institutions-manager.html" -%}
{% include "scripts/authors-manager.html" -%}
{% include "scripts/affiliations-manager.html" -%}
{% include "scripts/abstract-authors.html" %}

<script defer>
// Display a warning when navigating out of the page
// TODO: adjust when it should be displayed
/*window.onbeforeunload = function() {
  return true;
};*/

const personalDataManager = () => {
  let abstract_submission_open = {{submission_open}};

  let element = document.getElementById('personal-data');
  let studentSwitchElement = document.getElementById('student');
  let memberSwitchElement = document.getElementById('member');
  let scholarshipSwitchElement = document.getElementById('scholarship');
  let unemployedSwitchElement = document.getElementById('unemployed');
  let competitionTalkSwitchElement = document.getElementById('competition-talk');
  let competitionPhotographySwitchElement = document.getElementById('competition-photography');
  let competitionTalkElement = document.getElementById('competition-talk-selector')
  let scholarshipElement = document.getElementById('scholarship-selector');
  let studentVolunteerElement = document.getElementById('student-volunteer');
  {# let dinnerSwitchElement = document.getElementById('dinner');
  let dinnerTypeElement = document.getElementById('dinner-type-selector'); #}
  let firstName = document.getElementById('first-name');
  let lastName = document.getElementById('last-name');

  let saveFlag = false;

  const save = () => {
    if(saveFlag) {
      saveFlag = false;

      let data = new FormData(element);
      data.append('first-name', firstName.value);
      data.append('last-name', lastName.value);
      data.append('student', studentSwitchElement.checked);
      data.append('member', memberSwitchElement.checked);
      data.append('scholarship', scholarshipSwitchElement.checked);
      data.append('unemployed', unemployedSwitchElement.checked);
      data.append('competition_talk', competitionTalkSwitchElement.checked);
      data.append('competition_photography', competitionPhotographySwitchElement.checked);
      {# data.append('dinner', dinnerSwitchElement.checked);
      data.append('dinner_type', document.querySelector('input[name="dinner-type"]:checked').value); #}

      fetch("{{ url_for('IX_IPC.save_personal_data') }}", {
        method: 'POST',
        body: data
      })
      .catch((e) => console.log(e));
    }
  }

  const scheduleSave = () => {
    saveFlag = true;
    setTimeout(save, 2000);
  }

  element.addEventListener(
    'input',
    scheduleSave
  );

  const earlyBirdDate = new Date('2024-09-27');

  const updatePrice = () => {
    const prices = (earlyBirdDate > (new Date()))
      //   non-member, member, student non-member, student member non-scholarship, student member scholarship
        ? [150,        90,     70,                 25,                             40                         ]
        : [200,        150,    120,                60,                             70                         ];
    
    const priceElement = document.getElementById('final-price');
    if(priceElement) { 
      if(studentSwitchElement.checked || unemployedSwitchElement.checked) {
        if(memberSwitchElement.checked) {
          if(scholarshipSwitchElement.checked) {
            priceElement.innerHTML = String(prices[4]) + '€';
          } else {
            priceElement.innerHTML = String(prices[3]) + '€';
          }
        } else {
          priceElement.innerHTML = String(prices[2]) + '€';
        }
      } else {
        if(memberSwitchElement.checked) {
          priceElement.innerHTML = String(prices[1]) + '€';
        } else {
          priceElement.innerHTML = String(prices[0]) + '€';
        }
      }
    }
  }

  const updateStudent = () => {  
    if(studentSwitchElement.checked) {
      studentVolunteerElement.removeAttribute('hidden');
      competitionTalkElement.removeAttribute('hidden');
      if(memberSwitchElement.checked) {
        scholarshipElement.removeAttribute('hidden');
      }
    } else {
      studentVolunteerElement.setAttribute('hidden', '');
      scholarshipElement.setAttribute('hidden', '');
      scholarshipSwitchElement.checked = false;
      competitionTalkElement.setAttribute('hidden', '');
      competitionTalkSwitchElement.checked = false;
    }
    updatePrice();
  }
  updateStudent();

  studentSwitchElement.addEventListener(
    'change', updateStudent
  );

  const updateMember = () => {
    if(memberSwitchElement.checked && studentSwitchElement.checked) {
      scholarshipElement.removeAttribute('hidden');
    } else {
      scholarshipElement.setAttribute('hidden', '');
      scholarshipSwitchElement.checked = false;
    }
    updatePrice();
  }
  updateMember();

  memberSwitchElement.addEventListener(
    'change', updateMember
  );

  unemployedSwitchElement.addEventListener(
    'change', updatePrice
  );

  scholarshipSwitchElement.addEventListener(
    'change', updatePrice
  );

  updatePrice();

  {# const updateDinner = () => {
    if(dinnerSwitchElement.checked) {
      dinnerTypeElement.removeAttribute('hidden');
    } else {
      dinnerTypeElement.setAttribute('hidden', '');
    }
  }

  dinnerSwitchElement.addEventListener(
    'change', updateDinner
  );

  updateDinner(); #}

  return {
    'scheduleSave': scheduleSave,
    'save': save
  }
}
let personalData = personalDataManager();

let authors = authorsManager();
let institutions = institutionsManager();

let affiliations = {};
let abstractAuthors = {};
Promise.all([authors, institutions]).then((values) =>{
  authors = values[0];
  institutions = values[1];
  affiliations = affiliationsManager(authors, institutions);
  abstractAuthors = abstractAuthorsManager(authors);
});

const addAbstract = (event) => {
  if(abstract_submission_open) {
    event.preventDefault();
    let id = null;
    let container = document.getElementById('abstract-forms-container');
    fetch("{{ url_for('IX_IPC.create_new_abstract', language=lang) }}", {
      method: 'POST',
      body: new FormData(document.getElementById('abstract-new'))
    })
    .then((response) => response.json())
    .then((data) => {
      const div = document.createElement('div');
      id = data['id'];
      div.id = 'abstract-' + String(id);
      div.innerHTML = data['html'];
      container.appendChild(div);
      openAbstract(id);
    })
    .catch((e) => console.log(e));

    const callback = (mutationList, observer) => {
      document.getElementById('abstract-' + String(id)).scrollIntoView({behavior: "smooth", block: "center"});
      observer.disconnect();
    }

    const config = { attributes: false, childList: true, subtree: false };
    const observer = new MutationObserver(callback);
    observer.observe(container, config);
  }
}
if (abstract_submission_open) {
  document.getElementById('abstract-new').addEventListener(
    'click',
    addAbstract
  );
}
</script>

{# {% include 'scripts/payment-logic.html' %} #}