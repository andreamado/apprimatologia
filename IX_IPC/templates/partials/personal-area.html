<div class="text-white mb-5" id="personal-area">
  <h2 class="mb-1">{{ 'IXIPC-hi'|l10n(lang) }}, {{ g.IXIPC_user.name }}!</h2>
  <p class="lead mb-5">{{ 'IXIPC-register-to-submit-logged-in'|l10n(lang) }}</p>

  <!-- Personal data form -->
  <div class="container text-white mb-5">
    <form id="personal-data" action="">
      {{ registration_form.csrf_token }}
      <div class="rounded-4 card mb-3 abstract-new">
        <div class="card-body">
          <h5 class="card-title mb-0">
            {{ 'IXIPC-personal-data'|l10n(lang) }}
          </h5>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="email" class="form-label">Email</label>
          <input class="form-control" name="email" id="email" type="text" value="{{g.IXIPC_user.email}}" disabled>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="first-name" class="form-label">{{ 'IXIPC-personal-data-first-name'|l10n(lang) }}</label>
          <input name="first-name" id="first-name" type="text" class="form-control" value="{{g.IXIPC_user.first_name if g.IXIPC_user.first_name else ''}}">
        </div>
        <div class="col">
          <label for="last-name" class="form-label">{{ 'IXIPC-personal-data-last-name'|l10n(lang) }}</label>
          <input name="last-name" id="last-name" type="text" class="form-control" value="{{g.IXIPC_user.last_name if g.IXIPC_user.last_name else ''}}">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="institution" class="form-label">{{ 'IXIPC-personal-data-institution'|l10n(lang) }}</label>
          <input name="institution" id="institution" type="text" class="form-control" value="{{g.IXIPC_user.institution if g.IXIPC_user.institution else ''}}">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="student"{{' checked' if g.IXIPC_user.student}}>
            <label for="student" class="form-label">{{ 'IXIPC-personal-data-student'|l10n(lang) }}</label>
          </div>
        </div>
        <div class="col-auto" id="student-volunteer" hidden>
          <p>{{ 'IXIPC-personal-data-volunteer'|l10n(lang) }}</p>
        </div>
      </div>
    </form>
  </div>

  <!-- Payment form -->
  <div class="container text-white mb-5">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-registration'|l10n(lang) }}
        </h5>
      </div>
    </div>
    <div class="mt-3" id="payment">
      {# <h5>Preços</h5> #}
      <div class="row mb-3">
        <div class="col">
          <table class="table table-borderless rounded-2 overflow-hidden">
            <thead class="table-dark">
              <tr class="text-center">
                <th class="invisible" scope="col"></th>
                <th scope="col">{{ 'IXIPC-payment-earlybird'|l10n(lang) }}</th>
                <th scope="col">{{ 'IXIPC-payment-late'|l10n(lang) }}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">{{ 'IXIPC-payment-normal'|l10n(lang) }}</th>
                <td class="text-center">80€</td>
                <td class="text-center">100€</td>
              </tr>
              <tr>
                <th scope="row">{{ 'IXIPC-payment-student'|l10n(lang) }}</th>
                <td class="text-center">35€</td>
                <td class="text-center">50€</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% if payment_status == 0 %}
        <h5>{{ 'IXIPC-payment-methods-available'|l10n(lang) }}</h5>
      {% endif %}
      <div id="payment-methods" class="mb-3">
        <div class="row">
          {% if payment_status == 0 %}
            {% include 'partials/payment-methods.html' %}
          {% elif payment_status == 1 %}
            {% include 'partials/payment-success.html' %}
          {% elif payment_status == 2 %}
            {% include 'partials/payment-pending.html' %}
          {% endif %}
          <div class="col-2 ms-0 ps-0">
            <div class="card text-center w-100 h-100 rounded-start-0 price d-flex">
              <div class="flex-fill"></div>
              <h5 class="card-title mt-2 mb-1">Total</h5>
              <p class="card-text lead" id="final-price">100€</p>
              <div class="flex-fill"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-auto">
          <button type="submit" class="btn btn-primary" id="button-payment">{{ 'IXIPC-payment-pay'|l10n(lang) }}</button>
        </div>
        <div class="col" id="payment-notification"></div>
      </div>
      
    </div>
  </div>

  <!-- Abstracts -->
  <div class="container text-white mb-5">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-abstract-body'|l10n(lang) }}s
        </h5>
      </div>
    </div>

    <div class="container mb-5">
      <div id="abstract-forms-container">
        {% for abstract in abstracts -%}
        <div id="abstract-{{ abstract.id }}">
          {% include "abstract-form-closed.html" -%}
        </div>
        {% endfor -%}
      </div>
      <form id="abstract-new" action="" class="mb-5">
        {{ registration_form.csrf_token }}
        <button type="button" class="btn btn-primary text-white" type="submit">
          <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
          <span class="text-white">{{ 'IXIPC-abstract-new-abstract'|l10n(lang) }}</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Authors -->
  <div class="container text-white mb-3">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-abstract-authors'|l10n(lang)|l10n(lang) }}
        </h5>
      </div>
    </div>
  </div>
  <div class="container mb-5">
    <div class="row mb-3">
      <div class="accordion" id="accordion-authors"></div>
    </div>
    <button type="button" class="btn btn-primary text-white" type="submit" id="new-author-button">
      <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
      <span class="text-white">{{ 'IXIPC-abstract-new-author'|l10n(lang) }}</span>
    </button>
  </div>

  <!-- Institutions -->
  <div class="container text-white mb-3">
    <div class="rounded-4 card mb-3 abstract-new">
      <div class="card-body">
        <h5 class="card-title mb-0">
          {{ 'IXIPC-abstract-institutions'|l10n(lang)|l10n(lang) }}
        </h5>
      </div>
    </div>
  </div>
  <div class="container mb-5">
    <div class="row mb-3">
      <div class="accordion" id="accordion-institutions"></div>
    </div>
    <button type="button" class="btn btn-primary text-white" type="submit" id="new-institution-button">
      <img src='data:image/svg+xml,<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9L12 15" stroke="%23fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12C3 4.5885 4.5885 3 12 3C19.4115 3 21 4.5885 21 12C21 19.4115 19.4115 21 12 21C4.5885 21 3 19.4115 3 12Z" stroke="%23fff" stroke-width="2"/></svg>' alt="" style="height: 25px;">
      <span class="text-white">{{ 'IXIPC-abstract-new-institution'|l10n(lang) }}</span>
    </button>
  </div>

  <!-- Payment proof -->
  <!--<div class="mb-5">
    <h4 class="mb-0">{{'IXIPC-upload-payment-proof'|l10n(lang)}}</h4>
    <img src="" alt="" id="upload-result" class="upload-result">
    {% with upload_area={'id': 'IXIPC-upload-payment-proof'} -%}
      {% include "partials/upload-form.html" -%}
    {% endwith -%}
    <p id="upload-result-text" class="lead upload-result-text">&nbsp;</p>
  </div>-->

  <!-- Logout -->
  <div class="mb-5">
    <form action="{{ url_for('IX_IPC.logout', language=lang) }}" method="post">
      {{ registration_form.csrf_token }}
      <input type="hidden" id="user_id" name="user_id" value="{{ g.user.id }}"> 
      <button type="submit" class="btn btn-primary">{{ 'IXIPC-logout'|l10n(lang) }}</button>
    </form>  
  </div>
</div>

{% include "scripts/utilities.html" -%}
{# {% include "scripts/upload-form.html" -%} #}
{% include "scripts/word-counter.html" -%}
{% include "scripts/open-abstract.html" -%}
<script src="{{ url_for('static', filename='js/Sortable.js') }}"></script>
{# {% include "scripts/authors-manager.html" -%} #}
{% include "scripts/institutions-manager.html" -%}
{% include "scripts/authors-manager.html" -%}
{% include "scripts/affiliations-manager.html" -%}
{% include "scripts/abstract-authors.html" %}

<script defer>
// Display a warning when navigating out of the page
// TODO: adjust when it should be displayed
/*window.onbeforeunload = function() {
  return true;
};*/

const personalDataManager = () => {
  let element = document.getElementById('personal-data');
  let studentSwitchElement = document.getElementById('student');
  let studentVolunteerElement = document.getElementById('student-volunteer');

  let saveFlag = false;

  const save = () => {
    if(saveFlag) {
      saveFlag = false;

      let data = new FormData(element);
      data.append('student', studentSwitchElement.checked);

      fetch("{{ url_for('IX_IPC.save_personal_data') }}", {
        method: 'POST',
        body: data
      })
      .catch((e) => console.log(e));
    }
  }

  const scheduleSave = () => {
    saveFlag = true;
    setTimeout(save, 2000);
  }

  element.addEventListener(
    'input',
    scheduleSave
  );

  const updateStudent = () => {
    const priceElement = document.getElementById('final-price');
    // TODO: update with the correct dates and prices
    const prices = ((new Date('2024-08-16') > (new Date())))?[35, 80]:[50, 100];
  
    if(studentSwitchElement.checked) {
      if(priceElement) priceElement.innerHTML = String(prices[0]) + '€';
      studentVolunteerElement.removeAttribute('hidden');
    } else {
      if(priceElement) priceElement.innerHTML = String(prices[1]) + '€';
      studentVolunteerElement.setAttribute('hidden', '');
    }
  }
  updateStudent();

  studentSwitchElement.addEventListener(
    'change', updateStudent
  );

  return {
    'scheduleSave': scheduleSave,
    'save': save
  }
}
let personalData = personalDataManager();

let authors = authorsManager();
let institutions = institutionsManager();

let affiliations = {};
let abstractAuthors = {};
Promise.all([authors, institutions]).then((values) =>{
  authors = values[0];
  institutions = values[1];
  affiliations = affiliationsManager(authors, institutions);
  abstractAuthors = abstractAuthorsManager(authors);
});

/*makeUploader(
  dropArea = document.getElementById('IXIPC-upload-payment-proof'),
  csrfToken = '{{ csrf_token() }}'
);*/

const addAbstract = (event) => {
  event.preventDefault();
  let id = null;
  let container = document.getElementById('abstract-forms-container');
  fetch("{{ url_for('IX_IPC.create_new_abstract', language=lang) }}", {
    method: 'POST',
    body: new FormData(document.getElementById('abstract-new'))
  })
  .then((response) => response.json())
  .then((data) => {
    const div = document.createElement('div');
    id = data['id'];
    div.id = 'abstract-' + String(id);
    div.innerHTML = data['html'];
    container.appendChild(div);
  })
  .catch((e) => console.log(e));

  const callback = (mutationList, observer) => {
    document.getElementById('abstract-' + String(id)).scrollIntoView({behavior: "smooth", block: "center"});
    observer.disconnect();
  }

  const config = { attributes: false, childList: true, subtree: false };
  const observer = new MutationObserver(callback);
  observer.observe(container, config);
}

document.getElementById('abstract-new').addEventListener(
  'click',
  addAbstract
);
</script>
<script defer>
  const verifyPayment = (id, containerElement) => {
    setTimeout(() => {
      let form = blankForm();
      form.append('payment_id', id);

      fetch("{{ url_for('IX_IPC.check_mbway_status', language=lang) }}", {
        method: 'POST',
        body: form
      })
      .then((response) => response.json())
      .then((data) => {
        if(data['status'] == 1) {
          containerElement.innerHTML = `{% include 'partials/payment-success.html' %}`;
        } else if(data['status'] == 3 || data['status'] == 4 || data['status'] == 5) {
          // TODO: improve messaging to user when payment fails
          containerElement.innerHTML = `{% include 'partials/payment-failed.html' %}`;
        } else {
          verifyPayment(id, containerElement);
        }
      })
      .catch((e) => console.log(e))
    }, 5000);
  }

  // Manage payments
  (function() {
    let buttonPayment = document.getElementById('button-payment');
    let mbwayArea = document.getElementById('mbway-area');
    let mbwayContact = document.getElementById('mbway-contact');
    let ccardArea = document.getElementById('ccard-area');
    let containerElement = document.getElementById('payment-methods').firstElementChild.firstElementChild;
    let notificationArea = document.getElementById('payment-notification');

    buttonPayment.addEventListener('click', async (evt) => {
      evt.preventDefault();

      if(mbwayArea.getAttribute('active')) {
        // MBWay payment
        if(mbwayContact.value) {
          let form = blankForm();
          form.append('number', mbwayContact.value);
          
          fetch("{{ url_for('IX_IPC.payment_mbway', language=lang) }}", {
            method: 'POST',
            body: form
          })
          .then((response) => response.json())
          .then((data) => {
            let id = data['id'];
            if(id) {
              containerElement.innerHTML = `{% include 'partials/payment-pending.html' %}`;
              verifyPayment(id, containerElement);
            }
          })
          .catch((e) => console.log(e));
        } else {
          notificationArea.innerHTML = 'Please fill the phone number field with a valid phone number';
        }
      } else {
        // CCard payment
        fetch("{{ url_for('IX_IPC.start_creditcard_payment', language=lang) }}", {
          method: 'POST',
          body: blankForm()
        })
        .then((response) => response.json())
        .then((data) => {
          let id = data['id'];
          if(id) {
            // Redirects the user to the payment page
            window.location.href = data['url'];
          }
        })
        .catch((e) => console.log(e));
      }
    })
  })();

  /* // MBWay payment
  (function() {
    let mbwayButton = document.getElementById('mbway-payment');
    let mbwayContact = document.getElementById('mbway-contact');

    mbwayButton.addEventListener('click', async (evt) => {
      evt.preventDefault();

      let containerElement = document.getElementById('payment-methods').firstElementChild.firstElementChild;

      if(mbwayContact.value) {
        // TODO: validate phone number and display errors if not valid
        let form = blankForm();
        form.append('number', mbwayContact.value);
        
        fetch("{{ url_for('IX_IPC.payment_mbway', language=lang) }}", {
          method: 'POST',
          body: form
        })
        .then((response) => response.json())
        .then((data) => {
          let id = data['id'];
          if(id) {
            containerElement.innerHTML = `{% include 'partials/payment-pending.html' %}`;
            verifyPayment(id, containerElement);
          }
        })
        .catch((e) => console.log(e));
      }
    });
  })(); */

  /*// Credit card payment
  (function() {
    let creditCardButton = document.getElementById('card-payment');

    creditCardButton.addEventListener('click', async (evt) => {
      evt.preventDefault();

      fetch("{{ url_for('IX_IPC.start_creditcard_payment', language=lang) }}", {
        method: 'POST',
        body: blankForm()
      })
      .then((response) => response.json())
      .then((data) => {
        let id = data['id'];
        if(id) {
          // Redirects the user to the payment page
          window.location.href = data['url'];
        }
      })
      .catch((e) => console.log(e));
    });
  })();*/
</script>